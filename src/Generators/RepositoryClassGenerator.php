<?php

namespace LaraSpell\Generators;

use LaraSpell\Schema\Table;

class RepositoryClassGenerator extends ClassGenerator
{

    protected $tableSchema;

    public function __construct(Table $tableSchema)
    {
        parent::__construct($tableSchema->getRepositoryClass());
        $this->tableSchema = $tableSchema;
        $this->initClass();
        $this->addMethodsFromReflection();
    }

    protected function initClass()
    {
        $schema = $this->tableSchema;
        $table = $schema->getName();
        $fillables = $schema->getFillableColumns();
        $searchables = array_values(array_map(function($field) {
            return $field->getColumnName();
        }, $schema->getSearchableFields()));
        $this->useClass($schema->getModelClass());
        $this->useClass($schema->getRepositoryInterface(), $schema->getRepositoryInterface(false).'Interface');
        $this->setParentClass('BaseRepository');
        $this->addProperty('searchables', 'array', 'protected', $searchables, 'Searchable columns');
        $this->addImplement($schema->getRepositoryInterface(false).'Interface');
        $this->setDocblock(function($docblock) use ($schema) {
            $authorName = $schema->getRootSchema()->getAuthorName();
            $authorEmail = $schema->getRootSchema()->getAuthorEmail();
            $docblock->addText("Generated by LaraSpell");
            $docblock->addAnnotation("author", "{$authorName} <{$authorEmail}>");
            $docblock->addAnnotation("created", date('r'));
        });
    }

    protected function setMethodConstruct(MethodGenerator $method)
    {
        $modelClass = $this->tableSchema->getModelClass(true);
        $method->addArgument('model', $modelClass);
        $method->setDocblock(function($docblock) use ($modelClass) {
            $docblock->addText("Constructor");
            $docblock->addParam('model', $modelClass);
        });
        $method->setCode(function($code) use ($modelClass) {
            $code->addCode('parent::__construct($model);');
        });
    }

}
